# 电商网站秒杀系统设计方案

## 1. 项目概述

### 1.1 项目背景
商品秒杀作为一种营销工具，利用限时限量、先到先得的用户心理，刺激购买或制造机会吸引用户的注意力。随着秒杀玩法的升级，大折扣券现在开始作为商品使用，优惠券联动玩法促进店铺销售。

### 1.2 项目目标
使用分布式缓存Redis实现电商秒杀抢购功能，指导用户体验如何配置及使用华为云分布式缓存Redis。

### 1.3 技术环境
- **Java版本**: OpenJDK 25
- **框架**: Spring Boot 4.0.x
- **数据库**: MySQL 8.0 (端口3306，密码123456)
- **缓存**: Redis (端口6379)
- **构建工具**: Maven 3.x
- **部署**: 华为云

## 2. 系统需求分析

### 2.1 功能需求

#### 2.1.1 Redis缓存实例配置
- 创建和配置Redis缓存实例公网访问
- Redis连接池配置优化
- Redis集群配置（可选）

#### 2.1.2 电商产品查询
- 商品基本信息查询
- 商品库存查询
- 商品分类查询
- 商品搜索功能

#### 2.1.3 电商网站秒杀功能
- 秒杀商品展示
- 秒杀活动时间控制
- 用户秒杀抢购
- 库存扣减
- 订单生成
- 防刷机制
- 并发控制

#### 2.1.4 电商网站云部署
- 应用容器化
- 华为云部署配置
- 负载均衡配置
- 监控和日志配置

### 2.2 非功能需求
- **高并发**: 支持万级并发用户同时秒杀
- **高性能**: 响应时间 < 100ms
- **高可用**: 系统可用性 > 99.9%
- **数据一致性**: 保证库存数据准确性
- **安全性**: 防止恶意刷单和攻击

## 3. 系统架构设计

### 3.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户前端      │    │   管理后台      │    │   移动端APP     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   Nginx/网关    │
                    └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │  Spring Boot    │
                    │   应用集群      │
                    └─────────────────┘
                                 │
         ┌───────────────────────┼───────────────────────┐
         │                       │                       │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│     Redis       │    │     MySQL       │    │   消息队列      │
│   分布式缓存    │    │    主数据库     │    │   (RabbitMQ)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 3.2 技术选型

| 组件 | 技术选型 | 版本 | 说明 |
|------|----------|------|------|
| 开发框架 | Spring Boot | 4.0.x | 主开发框架 |
| 数据库 | MySQL | 8.0+ | 主数据存储 |
| 缓存 | Redis | 7.0+ | 分布式缓存 |
| 消息队列 | RabbitMQ | 3.12+ | 异步处理 |
| ORM框架 | MyBatis Plus | 3.5+ | 数据访问层 |
| 连接池 | HikariCP | 5.0+ | 数据库连接池 |
| 模板引擎 | Thymeleaf | 3.2+ | 前端模板 |
| JSON处理 | Jackson | 2.15+ | JSON序列化 |
| 日志 | Logback | 1.4+ | 日志框架 |

## 4. 数据库设计

### 4.1 核心表结构

#### 4.1.1 商品表 (tb_product)
```sql
CREATE TABLE tb_product (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    product_name VARCHAR(100) NOT NULL COMMENT '商品名称',
    product_desc TEXT COMMENT '商品描述',
    price DECIMAL(10,2) NOT NULL COMMENT '商品价格',
    stock_count INT NOT NULL DEFAULT 0 COMMENT '库存数量',
    category_id BIGINT COMMENT '商品分类ID',
    status TINYINT DEFAULT 1 COMMENT '商品状态 1-正常 0-下架',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_category (category_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品表';
```

#### 4.1.2 秒杀商品表 (tb_seckill_product)
```sql
CREATE TABLE tb_seckill_product (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    product_id BIGINT NOT NULL COMMENT '商品ID',
    seckill_price DECIMAL(10,2) NOT NULL COMMENT '秒杀价格',
    stock_count INT NOT NULL COMMENT '秒杀库存',
    start_time DATETIME NOT NULL COMMENT '秒杀开始时间',
    end_time DATETIME NOT NULL COMMENT '秒杀结束时间',
    status TINYINT DEFAULT 1 COMMENT '状态 1-正常 0-结束',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_product (product_id),
    INDEX idx_time (start_time, end_time),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='秒杀商品表';
```

#### 4.1.3 用户表 (tb_user)
```sql
CREATE TABLE tb_user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
    password VARCHAR(100) NOT NULL COMMENT '密码',
    nickname VARCHAR(50) COMMENT '昵称',
    email VARCHAR(100) COMMENT '邮箱',
    phone VARCHAR(20) COMMENT '手机号',
    status TINYINT DEFAULT 1 COMMENT '状态 1-正常 0-禁用',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

#### 4.1.4 秒杀订单表 (tb_seckill_order)
```sql
CREATE TABLE tb_seckill_order (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_no VARCHAR(64) NOT NULL UNIQUE COMMENT '订单号',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    product_id BIGINT NOT NULL COMMENT '商品ID',
    seckill_price DECIMAL(10,2) NOT NULL COMMENT '秒杀价格',
    quantity INT DEFAULT 1 COMMENT '购买数量',
    total_amount DECIMAL(10,2) NOT NULL COMMENT '总金额',
    status TINYINT DEFAULT 0 COMMENT '订单状态 0-待支付 1-已支付 2-已发货 3-已完成 -1-已取消',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    pay_time DATETIME COMMENT '支付时间',
    INDEX idx_user (user_id),
    INDEX idx_product (product_id),
    INDEX idx_order_no (order_no),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='秒杀订单表';
```

## 5. Redis缓存设计

### 5.1 缓存结构设计

#### 5.1.1 商品缓存
```
Key: product:info:{productId}
Type: Hash
TTL: 30分钟
Fields: {
    id, productName, productDesc, price, stockCount, categoryId
}
```

#### 5.1.2 秒杀商品缓存
```
Key: seckill:product:{seckillId}
Type: Hash
TTL: 活动结束时间
Fields: {
    id, productId, seckillPrice, stockCount, startTime, endTime, status
}
```

#### 5.1.3 秒杀库存缓存
```
Key: seckill:stock:{seckillId}
Type: String (原子计数器)
TTL: 活动结束时间
Value: 剩余库存数量
```

#### 5.1.4 用户购买记录
```
Key: seckill:user:{userId}:{seckillId}
Type: String
TTL: 活动结束时间
Value: 购买状态 (1-已购买)
```

### 5.2 缓存策略

#### 5.2.1 预热策略
- 秒杀活动开始前30分钟预热数据到Redis
- 商品基本信息提前缓存
- 秒杀库存数据同步到Redis

#### 5.2.2 更新策略
- 库存扣减使用Redis原子操作
- 订单创建后异步更新数据库
- 定时同步Redis与数据库数据

#### 5.2.3 过期策略
- 秒杀商品缓存自动过期
- 用户购买记录活动结束后自动清理
- 商品信息缓存定期刷新

## 6. 核心功能实现

### 6.1 秒杀流程设计

```
1. 用户请求秒杀商品
   ↓
2. 校验用户身份和活动状态
   ↓
3. 检查用户是否已购买
   ↓
4. Redis原子扣减库存
   ↓
5. 库存扣减成功？
   ├─ 是 → 创建订单记录
   │        ↓
   │        异步处理订单
   │        ↓
   │        返回成功
   └─ 否 → 返回失败
```

### 6.2 防刷机制

#### 6.2.1 接口限流
- 使用Redis实现滑动窗口限流
- 单用户限流：每秒最多1次请求
- 全局限流：每秒最多10000次请求

#### 6.2.2 验证码机制
- 图形验证码防止机器刷单
- 数学验证码增加难度
- 验证码有效期5分钟

#### 6.2.3 黑名单机制
- 异常IP自动加入黑名单
- 恶意用户账号封禁
- 黑名单定期清理

### 6.3 并发控制

#### 6.3.1 Redis分布式锁
```
Key: lock:seckill:{seckillId}
TTL: 10秒
Value: 用户ID + 时间戳
```

#### 6.3.2 数据库乐观锁
```sql
UPDATE tb_seckill_product
SET stock_count = stock_count - 1, version = version + 1
WHERE id = #{seckillId} AND stock_count > 0 AND version = #{version}
```

## 7. 接口设计

### 7.1 商品查询接口

#### 7.1.1 获取商品列表
```
GET /api/products
参数: page, size, categoryId
返回: 商品分页列表
```

#### 7.1.2 获取商品详情
```
GET /api/products/{productId}
返回: 商品详细信息
```

### 7.2 秒杀相关接口

#### 7.2.1 获取秒杀商品列表
```
GET /api/seckill/products
返回: 当前可秒杀商品列表
```

#### 7.2.2 获取秒杀商品详情
```
GET /api/seckill/products/{seckillId}
返回: 秒杀商品详细信息
```

#### 7.2.3 执行秒杀
```
POST /api/seckill/order
参数: seckillId, captcha, quantity
返回: 订单信息或错误信息
```

#### 7.2.4 获取验证码
```
GET /api/seckill/captcha?seckillId={seckillId}
返回: 验证码图片
```

### 7.3 订单相关接口

#### 7.3.1 查询订单
```
GET /api/orders/{orderNo}
返回: 订单详细信息
```

#### 7.3.2 订单列表
```
GET /api/orders
参数: page, size, status
返回: 用户订单列表
```

## 8. 部署方案

### 8.1 本地开发环境

#### 8.1.1 环境要求
- JDK 25
- Maven 3.8+
- MySQL 8.0+
- Redis 7.0+

#### 8.1.2 启动顺序
1. 启动MySQL数据库
2. 启动Redis服务
3. 运行数据库初始化脚本
4. 启动Spring Boot应用

### 8.2 华为云部署

#### 8.2.1 云服务选型
- **ECS**: 弹性云服务器 (2核4G起步)
- **RDS**: 云数据库MySQL
- **DCS**: 分布式缓存服务Redis
- **ELB**: 弹性负载均衡
- **CCE**: 云容器引擎 (可选)

#### 8.2.2 部署架构
```
                    ┌─────────────────┐
                    │      ELB        │
                    │   负载均衡      │
                    └─────────────────┘
                            │
            ┌───────────────┼───────────────┐
            │               │               │
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │    ECS-1    │ │    ECS-2    │ │    ECS-N    │
    │ 应用实例1   │ │ 应用实例2   │ │ 应用实例N   │
    └─────────────┘ └─────────────┘ └─────────────┘
            │               │               │
            └───────────────┼───────────────┘
                            │
            ┌───────────────┼───────────────┐
            │               │               │
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │     RDS     │ │     DCS     │ │   RabbitMQ  │
    │   MySQL     │ │    Redis    │ │  消息队列   │
    └─────────────┘ └─────────────┘ └─────────────┘
```

#### 8.2.3 容器化部署

**Dockerfile示例:**
```dockerfile
FROM openjdk:25-jdk-slim
COPY target/seckill-1.0-SNAPSHOT.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "/app.jar"]
```

**docker-compose.yml示例:**
```yaml
version: '3.8'
services:
  seckill-app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/seckill
      - SPRING_REDIS_HOST=redis
    depends_on:
      - mysql
      - redis
```

## 9. 监控和运维

### 9.1 监控指标
- **系统指标**: CPU、内存、磁盘、网络
- **应用指标**: QPS、响应时间、错误率
- **业务指标**: 秒杀成功率、库存准确性

### 9.2 日志管理
- **应用日志**: Logback + SLF4J
- **访问日志**: Nginx访问日志
- **错误日志**: 异常堆栈信息
- **审计日志**: 用户操作记录

### 9.3 告警策略
- **系统告警**: 资源使用率超过80%
- **应用告警**: 错误率超过5%
- **业务告警**: 秒杀成功率异常

## 10. 安全考虑

### 10.1 数据安全
- 用户密码BCrypt加密存储
- 敏感数据传输HTTPS加密
- 数据库访问权限控制

### 10.2 接口安全
- JWT Token身份认证
- 接口参数校验和过滤
- SQL注入防护

### 10.3 防攻击措施
- 防止CC攻击
- 防止恶意刷单
- 防止接口滥用

## 11. 性能优化

### 11.1 数据库优化
- 合理的索引设计
- 读写分离
- 连接池优化

### 11.2 缓存优化
- 多级缓存策略
- 缓存预热和更新
- 缓存穿透和雪崩防护

### 11.3 应用优化
- 异步处理
- 连接池配置
- JVM参数调优

## 12. 项目实施计划

### 阶段一：基础框架搭建 (3天)
- Spring Boot项目初始化
- 数据库设计和创建
- Redis环境配置
- 基础代码结构搭建

### 阶段二：核心功能开发 (5天)
- 商品管理模块
- 秒杀功能核心逻辑
- 订单管理模块
- 缓存策略实现

### 阶段三：系统优化 (3天)
- 性能优化和调优
- 并发测试和问题修复
- 安全机制完善

### 阶段四：部署上线 (2天)
- 华为云环境配置
- 应用部署和测试
- 监控配置和验证

## 13. 风险评估

### 13.1 技术风险
- 高并发下系统稳定性
- Redis与MySQL数据一致性
- 分布式系统的复杂性

### 13.2 业务风险
- 恶意刷单和作弊
- 库存超卖问题
- 用户体验影响

### 13.3 风险应对
- 充分的压力测试
- 完善的监控告警
- 快速的故障恢复机制

---

*本设计方案基于当前项目需求和技术环境制定，实施过程中可能根据实际情况进行适当调整。*